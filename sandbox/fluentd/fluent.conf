# Fluentd configuration for PhishNet Sandbox log aggregation

<source>
  @type forward
  port 24224
  bind 0.0.0.0
</source>

# Container logs
<source>
  @type tail
  path /var/log/sandbox/*.log
  pos_file /fluentd/log/sandbox.log.pos
  tag sandbox.logs
  format json
  time_format %Y-%m-%dT%H:%M:%S.%L%z
</source>

# Security events filter
<filter sandbox.logs>
  @type grep
  <regexp>
    key level
    pattern (ERROR|WARNING|CRITICAL)
  </regexp>
</filter>

# Add hostname and timestamp
<filter sandbox.**>
  @type record_transformer
  <record>
    hostname "#{Socket.gethostname}"
    service sandbox
    timestamp ${time}
  </record>
</filter>

# Security events to Redis for real-time monitoring
<match sandbox.logs>
  @type copy
  <store>
    @type redis_list
    host redis
    port 6379
    db_number 0
    key security_events
    serialize_format json
  </store>
  <store>
    @type stdout
  </store>
</match>

# All other logs to stdout
<match **>
  @type stdout
  format json
</match>
