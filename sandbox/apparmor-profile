# AppArmor profile for PhishNet sandbox containers
# Provides additional container security by restricting file system access

#include <tunables/global>

profile sandbox-profile flags=(attach_disconnected,mediate_deleted) {
  #include <abstractions/base>
  #include <abstractions/nameservice>
  #include <abstractions/openssl>
  #include <abstractions/ssl_certs>

  # Capabilities
  capability setgid,
  capability setuid,
  capability dac_override,
  capability net_bind_service,
  capability sys_admin,

  # Network access
  network inet dgram,
  network inet stream,
  network inet6 dgram,
  network inet6 stream,
  network netlink raw,
  network unix dgram,
  network unix stream,

  # File system access
  / r,
  /app/** r,
  /app/sandbox_worker.py ix,
  /app/artifact_storage.py r,
  /app/job_queue.py r,
  /app/monitoring.py r,
  /app/network_security.py r,
  
  # Python interpreter and libraries
  /usr/bin/python3.11 ix,
  /usr/lib/python3.11/** r,
  /usr/local/lib/python3.11/** r,
  
  # System libraries
  /lib/** r,
  /lib64/** r,
  /usr/lib/** r,
  /usr/lib64/** r,
  /usr/share/** r,
  
  # Chrome/Chromium
  /usr/bin/google-chrome ix,
  /usr/bin/chromium ix,
  /opt/google/chrome/** r,
  /opt/google/chrome/chrome ix,
  
  # Temporary directories (read/write)
  /tmp/** rw,
  /dev/shm/** rw,
  /var/tmp/** rw,
  
  # Device access
  /dev/null rw,
  /dev/zero r,
  /dev/random r,
  /dev/urandom r,
  /dev/tty rw,
  /dev/pts/* rw,
  
  # Proc filesystem (limited)
  /proc/*/fd/ r,
  /proc/*/mounts r,
  /proc/*/stat r,
  /proc/*/status r,
  /proc/meminfo r,
  /proc/cpuinfo r,
  /proc/sys/kernel/version r,
  
  # DNS resolution
  /etc/hosts r,
  /etc/resolv.conf r,
  /etc/nsswitch.conf r,
  /run/systemd/resolve/stub-resolv.conf r,
  
  # SSL certificates
  /etc/ssl/certs/** r,
  /usr/share/ca-certificates/** r,
  
  # Deny dangerous operations
  deny /boot/** rwklx,
  deny /sys/** rwklx,
  deny /proc/sys/** rwklx,
  deny /etc/passwd rwklx,
  deny /etc/shadow rwklx,
  deny /etc/sudoers rwklx,
  deny /root/** rwklx,
  deny /home/*/.ssh/** rwklx,
  deny /var/log/** wklx,
  deny /etc/crontab rwklx,
  deny /etc/cron.d/** rwklx,
  
  # Deny network configuration access
  deny /etc/network/** rwklx,
  deny /etc/systemd/network/** rwklx,
  deny /etc/netplan/** rwklx,
  
  # Deny package management
  deny /var/lib/dpkg/** rwklx,
  deny /var/lib/apt/** rwklx,
  deny /usr/bin/apt* x,
  deny /usr/bin/dpkg* x,
  
  # Site-specific additions
  /etc/sandbox/ r,
  /etc/sandbox/** r,
  /var/log/sandbox/ rw,
  /var/log/sandbox/** rw,
}
