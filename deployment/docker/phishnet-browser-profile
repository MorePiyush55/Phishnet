# AppArmor profile for PhishNet browser container
#include <tunables/global>

/app/browser_worker.py {
  #include <abstractions/base>
  #include <abstractions/python>
  #include <abstractions/nameservice>

  # Allow python execution
  /usr/bin/python3* ix,
  /usr/local/bin/python* ix,

  # Allow reading application files
  /app/** r,
  /app/screenshots/ rw,
  /app/screenshots/** rw,
  /app/logs/ rw,
  /app/logs/** rw,
  /app/temp/ rw,
  /app/temp/** rw,

  # Playwright/Chromium requirements
  /opt/ms-playwright/** r,
  /opt/ms-playwright/chromium*/chrome-linux/chrome px -> chrome_sandbox,
  /tmp/** rw,

  # System libraries
  /lib/** r,
  /usr/lib/** r,
  /usr/share/** r,

  # Network access (restricted)
  network inet stream,
  network inet6 stream,

  # Deny access to sensitive system areas
  deny /etc/shadow r,
  deny /etc/passwd r,
  deny /etc/group r,
  deny /root/** rwlkmx,
  deny /home/** rwlkmx,
  deny /var/log/** w,
  deny /sys/** w,

  # Chrome sandbox profile
  profile chrome_sandbox {
    #include <abstractions/base>
    
    /opt/ms-playwright/chromium*/chrome-linux/chrome mr,
    /opt/ms-playwright/chromium*/chrome-linux/chrome_sandbox ix,
    /tmp/** rw,
    /dev/shm/** rw,
    /proc/*/fd/ r,
    /proc/*/stat r,
    /proc/*/status r,
    /proc/meminfo r,
    /proc/cpuinfo r,
    
    # Network
    network inet stream,
    network inet6 stream,
    
    # Deny everything else
    deny /etc/** r,
    deny /root/** rwlkmx,
    deny /home/** rwlkmx,
  }
}
